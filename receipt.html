<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt</title>
    <link rel="stylesheet" href="receipt.css">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCX0vxlyd0hXXDur4v3SpAnNuRwrm4Fyyc",
            authDomain: "gas-refill-app.firebaseapp.com",
            projectId: "gas-refill-app",
            storageBucket: "gas-refill-app.appspot.com",
            messagingSenderId: "369760533545",
            appId: "1:369760533545:web:5bc99b940b30154fe3b038",
            measurementId: "G-8GV51M539Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize EmailJS
        emailjs.init("Wln1Nu2TKjqVMGCsA"); // Replace with your actual public key

        // Sample receipt data (replace with dynamic values)
        const params = {
            orderId: "12345", // Example order ID (replace with actual value)
            gasType: "LPG",
            quantity: 12, // This is a number
            orderDate: "2024-12-22T15:17:21.204Z", // Example order date
            deliveryAddress: "9 Tudun Wada",
            totalPrice: 5000, // Example total price
        };

        // Debugging - check if parameters are correctly retrieved
        console.log("Gas Type: ", params.gasType);
        console.log("Quantity: ", params.quantity);
        console.log("Order Date: ", params.orderDate);
        console.log("Delivery Address: ", params.deliveryAddress);
        console.log("Total Price: ", params.totalPrice);

        // Populate receipt fields
        document.getElementById('receiptDate').textContent = `Date: ${new Date().toLocaleString()}`;
        document.getElementById('receiptGasType').textContent = params.gasType;
        document.getElementById('receiptQuantity').textContent = params.quantity;
        document.getElementById('receiptTotalPrice').textContent = `₦${params.totalPrice}`;
        document.getElementById('receiptAddress').textContent = params.deliveryAddress;

        // Send email after the receipt is loaded
        onAuthStateChanged(auth, async (user) => {
            let userEmail = 'derickkingdomanimation@gmail.com'; // Default email if no user is logged in

            if (user) {
                userEmail = user.email; // Use logged-in user's email
            }

            // Prepare the email data object
            const emailData = {
                to_email: userEmail, 
                orderId: params.orderId, // Send the order ID
                gasType: params.gasType, // Send the gas type
                quantity: params.quantity, // Send the quantity
                orderDate: new Date().toLocaleString(), // Send the order date
                deliveryAddress: params.deliveryAddress, // Send the delivery address
                totalPrice: params.totalPrice, // Send the total price
            };

            // Debugging - check email content before sending
            console.log("Email data to be sent:", emailData);

            try {
                // Send the email via EmailJS
                await emailjs.send("service_h6hlgaq", "template_talavm5", emailData);
                console.log('Receipt sent to:', userEmail);
            } catch (error) {
                console.error('Error sending email:', error);
            }
        });

        // Print receipt
        function printReceipt() {
            window.print();
        }

        // Download receipt as PDF
        async function downloadReceipt() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            pdf.setFontSize(16);
            pdf.text('Payment Receipt', 20, 20);
            pdf.setFontSize(12);
            pdf.text(`Date: ${new Date().toLocaleString()}`, 20, 30);
            pdf.text(`Gas Type: ${params.gasType}`, 20, 40);
            pdf.text(`Quantity: ${params.quantity} kg`, 20, 50);
            pdf.text(`Total Price: ₦${params.totalPrice}`, 20, 60);
            pdf.text(`Delivery Address: ${params.deliveryAddress}`, 20, 70);

            pdf.save('receipt.pdf');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>

</head>

<body>
    <div class="receipt-container">
        <h1>Payment Receipt</h1>
        <p id="receiptDate"></p>
        <table>
            <tr>
                <th>Gas Type</th>
                <td id="receiptGasType">N/A</td>
            </tr>
            <tr>
                <th>Quantity (kg)</th>
                <td id="receiptQuantity">N/A</td>
            </tr>
            <tr>
                <th>Total Price</th>
                <td id="receiptTotalPrice">₦0</td>
            </tr>
            <tr>
                <th>Delivery Address</th>
                <td id="receiptAddress">N/A</td>
            </tr>
        </table>
        <div class="buttons">
            <button onclick="printReceipt()">Print Receipt</button>
            <button onclick="downloadReceipt()">Download as PDF</button>
        </div>
    </div>
</body>

</html>
