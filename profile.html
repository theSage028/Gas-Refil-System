<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <script type="module" src="app.js" defer></script>
  <link rel="stylesheet" href="profile.css">
</head>
<body>
  <div class="container">
    <h1 id="profileName">User Profile</h1>
    
    <!-- Logout Button -->
    <button id="logoutButton">Logout</button>
    
    <!-- Profile Management Button -->
    <button id="editProfileButton">Edit Profile</button>

    <!-- Profile Management Modal -->
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeModalButton">&times;</span>
        <h2>Update Profile</h2>
        <form id="profileForm">
          <label for="displayName">Display Name</label>
          <input type="text" id="displayName" placeholder="Enter your display name" required />
          
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password" />
          
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm new password" />
          
          <button type="submit">Save Changes</button>
        </form>
      </div>
    </div>

    <!-- Place Order Button -->
    <button id="placeOrderButton" onclick="openOrderModal()">Place an Order</button>

    <!-- Order Form Modal -->
    <div id="orderModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeOrderModalButton">&times;</span>
        <h1>Place Your Order</h1>
        <form id="orderForm">
          <label for="gasType">Gas Type:</label>
          <select id="gasType" required>
            <option value="LPG" data-price="10">LPG ($10/kg)</option>
            <option value="CNG" data-price="8">CNG ($8/kg)</option>
          </select>
          <br>
    
          <label for="quantity">Quantity (kg):</label>
          <input type="number" id="quantity" min="1" required>
          <p id="priceTag">Total Price: $0</p>
          <br>
    
          <label for="deliveryAddress">Delivery Address:</label>
          <input type="text" id="deliveryAddress" required>
          <br>
    
          <button type="submit">Place Order</button>
        </form>
      </div>
    </div>
    
    <!-- Order History Button -->
    <button id="viewOrderHistoryButton">View Order History</button>

    <!-- Order History Modal -->
    <div id="orderHistoryModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeOrderHistoryModalButton">&times;</span>
        <h2>Order History</h2>
        <table id="orderHistoryTable">
          <thead>
            <tr>
              <th>Gas Type</th>
              <th>Date</th>
              <th>Quantity (kg)</th>
              <th>Delivery Address</th>
            </tr>
          </thead>
          <tbody>
            <!-- Orders will be dynamically added here -->
          </tbody>
        </table>
      </div>
    </div>  

    <!-- Rating Section -->
    <section id="ratingSection">
      <h2>Rate Your Experience</h2>
      <div class="rating">
        <span class="star" data-value="1">&#9733;</span>
        <span class="star" data-value="2">&#9733;</span>
        <span class="star" data-value="3">&#9733;</span>
        <span class="star" data-value="4">&#9733;</span>
        <span class="star" data-value="5">&#9733;</span>
      </div>
      <button id="submitRatingButton">Submit Rating</button>
    </section>
  </div>

  <script type="module">
    // Import Firebase services
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

// Your Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCX0vxlyd0hXXDur4v3SpAnNuRwrm4Fyyc",
  authDomain: "gas-refill-app.firebaseapp.com",
  projectId: "gas-refill-app",
  storageBucket: "gas-refill-app.firebasestorage.app",
  messagingSenderId: "369760533545",
  appId: "1:369760533545:web:5bc99b940b30154fe3b038",
  measurementId: "G-8GV51M539Z"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ================= Profile Modal Logic =================
let profileNameElement = document.getElementById('profileName'); // Display name element

// Function to load the user's display name from Firebase
const loadUserProfile = async () => {
  const user = auth.currentUser;

  if (user) {
    try {
      // Fetch the user's document from Firestore
      const userRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userRef);

      if (userDoc.exists()) {
        const userData = userDoc.data();
        const displayName = userData.displayName || user.displayName || "Profile"; // Fallback to "Profile" if no displayName exists
        profileNameElement.textContent = displayName; // Display the name in the profile section
      } else {
        // If the user document does not exist, fallback to "Profile"
        profileNameElement.textContent = "Profile";
      }
    } catch (error) {
      console.error("Error loading user profile:", error);
      profileNameElement.textContent = "Profile"; // Fallback to "Profile" if there is an error
    }
  } else {
    profileNameElement.textContent = "Profile"; // Fallback to "Profile" if no user is logged in
  }
};

// Listen for authentication state changes
onAuthStateChanged(auth, (user) => {
  loadUserProfile(); // Load the user's profile when the page loads or the auth state changes
});

// ================= Profile Modal Logic =================
const editProfileButton = document.getElementById('editProfileButton');
const profileModal = document.getElementById('profileModal');
const closeModalButton = document.getElementById('closeModalButton');

// Show the profile modal when clicking the "Edit Profile" button
editProfileButton.addEventListener('click', () => profileModal.style.display = 'block');
closeModalButton.addEventListener('click', () => profileModal.style.display = 'none');
window.addEventListener('click', (event) => {
  if (event.target === profileModal) profileModal.style.display = 'none';
});

// Handle profile update (display name and password)
const profileForm = document.getElementById('profileForm');
profileForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const displayName = document.getElementById('displayName').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  // Validate password if provided
  if (newPassword && newPassword !== confirmPassword) {
    alert("Passwords do not match.");
    return;
  }

  try {
    const user = auth.currentUser;
    if (!user) {
      console.error("No user is authenticated.");
      alert("You need to be logged in to update your profile.");
      return;
    }

    // Update the user's display name
    await updateProfile(user, {
      displayName: displayName,
    });

    // Check if the user's document exists in Firestore
    const userRef = doc(db, 'users', user.uid);
    const userDoc = await getDoc(userRef);

    if (!userDoc.exists()) {
      // If the document doesn't exist, create it
      console.log("User document doesn't exist. Creating a new document.");
      await setDoc(userRef, {
        displayName: displayName,
        email: user.email,
        // Add any other fields you want to store
      });
    } else {
      // If the document exists, update it
      console.log("User document exists. Updating document.");
      await updateDoc(userRef, {
        displayName: displayName,
      });
    }

    // Update the profile name on the page
    profileNameElement.textContent = displayName;

    // Close the modal after successful update
    profileModal.style.display = 'none';
    alert("Profile updated successfully.");
  } catch (error) {
    console.error("Error updating profile:", error.message || error);
    alert(`Failed to update profile. Error: ${error.message || error}`);
  }
});

  </script>

  <script>

    // ================= Order Modal Logic =================
    const orderModal = document.getElementById('orderModal');
    const closeOrderModalButton = document.getElementById('closeOrderModalButton');

    function openOrderModal() {
      orderModal.style.display = 'block';
    }
    closeOrderModalButton.addEventListener('click', () => orderModal.style.display = 'none');
    window.addEventListener('click', (event) => {
      if (event.target === orderModal) orderModal.style.display = 'none';
    });

    // ================= Price Calculation =================
    const gasTypeSelect = document.getElementById('gasType');
    const quantityInput = document.getElementById('quantity');
    const priceTag = document.getElementById('priceTag');

    function updatePrice() {
      const selectedGas = gasTypeSelect.options[gasTypeSelect.selectedIndex];
      const pricePerKg = parseFloat(selectedGas.getAttribute('data-price')) || 0;
      const quantity = parseFloat(quantityInput.value) || 0;
      const totalPrice = (pricePerKg * quantity).toFixed(2);
      priceTag.textContent = `Total Price: $${totalPrice}`;
    }

    gasTypeSelect.addEventListener('change', updatePrice);
    quantityInput.addEventListener('input', updatePrice);

    // ================= Order History Logic =================
    const viewOrderHistoryButton = document.getElementById('viewOrderHistoryButton');
    const orderHistoryModal = document.getElementById('orderHistoryModal');
    const closeOrderHistoryModalButton = document.getElementById('closeOrderHistoryModalButton');

    // Function to fetch order history from Firebase
    async function fetchOrderHistory(userId) {
      const orderHistoryTableBody = document.querySelector("#orderHistoryTable tbody");
      orderHistoryTableBody.innerHTML = ""; // Clear previous data

      // Assuming you're using Firebase Firestore
      const q = query(collection(db, "orders"), where("userId", "==", userId));
      try {
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
          const order = doc.data();
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${order.gasType}</td>
            <td>${new Date(order.orderDate).toLocaleString()}</td>
            <td>${order.quantity}</td>
            <td>${order.deliveryAddress}</td>
          `;
          orderHistoryTableBody.appendChild(row);
        });
      } catch (error) {
        console.error("Error fetching order history:", error);
        alert("Failed to load order history.");
      }
    }

    // Event listener to open order history modal and fetch orders
    viewOrderHistoryButton.addEventListener('click', () => {
      const userId = "user123"; // Replace with actual user ID
      fetchOrderHistory(userId);
      orderHistoryModal.style.display = 'block';
    });

    // Close modal logic
    closeOrderHistoryModalButton.addEventListener('click', () => {
      orderHistoryModal.style.display = 'none';
    });
    window.addEventListener('click', (event) => {
      if (event.target === orderHistoryModal) orderHistoryModal.style.display = 'none';
    });

  </script>
</body>
</html>
