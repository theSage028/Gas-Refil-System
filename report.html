<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
  import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCX0vxlyd0hXXDur4v3SpAnNuRwrm4Fyyc",
    authDomain: "gas-refill-app.firebaseapp.com",
    projectId: "gas-refill-app",
    storageBucket: "gas-refill-app.appspot.com",
    messagingSenderId: "369760533545",
    appId: "1:369760533545:web:5bc99b940b30154fe3b038",
    measurementId: "G-8GV51M539Z"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  console.log("Firebase initialized successfully");

  // Global variable for the current user
  let currentUser = null;

  // Listen for authentication state changes
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;  // If a user is logged in, save the user object
      console.log('User logged in:', currentUser.email);
    } else {
      currentUser = null;  // If no user is logged in, set it to null
      console.log('No user logged in');
    }
  });

  // Helper function to get the date range for reports
  function getDateRange(period) {
    const now = new Date();
    let startDate;
    let endDate;

    if (period === 'daily') {
      // Start of today (midnight)
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
    } else if (period === 'weekly') {
      // Start of this week (last Sunday)
      const lastSunday = new Date(now);
      lastSunday.setDate(now.getDate() - now.getDay()); // Go to Sunday
      lastSunday.setHours(0, 0, 0, 0);

      // End of this week (next Sunday)
      const nextSunday = new Date(lastSunday);
      nextSunday.setDate(lastSunday.getDate() + 7);
      nextSunday.setHours(23, 59, 59, 999);

      startDate = lastSunday;
      endDate = nextSunday;
    } else if (period === 'monthly') {
      // Start of current month
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      startDate.setHours(0, 0, 0, 0);

      // End of current month
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    }

    return { start: startDate, end: endDate };
  }

  // Function to generate report
  async function generateReport(period) {
    if (!currentUser) {
      alert("Please log in first.");
      window.location.href = "index.html"; // Redirect to login if not authenticated
      return;
    }

    const { start, end } = getDateRange(period);
    console.log(`Querying from ${start} to ${end}`); // Log the date range for debugging

    const ordersRef = collection(db, 'orders');
    const q = query(
      ordersRef,
      where("userId", "==", currentUser.uid),
      where("orderDate", ">=", start),
      where("orderDate", "<=", end)
    );

    try {
      const querySnapshot = await getDocs(q);
      const orders = [];
      querySnapshot.forEach((doc) => {
        const orderData = doc.data();
        const orderDate = new Date(orderData.orderDate);
        if (orderDate >= start && orderDate <= end) {
          orders.push({ id: doc.id, ...orderData });
        }
      });

      // Display report
      displayReport(orders, period);
    } catch (error) {
      console.error('Error generating report:', error);
      alert('Failed to generate report. Please try again.');
    }
  }

  // Function to display the report inside the modal
  function displayReport(orders, period) {
    const reportOutput = document.getElementById('reportOutput');
    const modal = document.getElementById('reportModal');

    if (orders.length === 0) {
      reportOutput.innerHTML = `<p>No orders found for this ${period}.</p>`;
    } else {
      reportOutput.innerHTML = ` 
        <h3>${period.charAt(0).toUpperCase() + period.slice(1)} Report</h3>
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Gas Type</th>
              <th>Quantity</th>
              <th>Order Date</th>
              <th>Delivery Address</th>
            </tr>
          </thead>
          <tbody>
            ${orders
              .map(
                (order) => ` 
              <tr>
                <td>${order.id}</td>
                <td>${order.gasType}</td>
                <td>${order.quantity}</td>
                <td>${new Date(order.orderDate).toLocaleString()}</td>
                <td>${order.deliveryAddress}</td>
              </tr>`
              )
              .join('')}
          </tbody>
        </table>
      `;
    }

    modal.style.display = "block";
  }

  // Function to close the modal
  window.closeModal = function () {
    const modal = document.getElementById('reportModal');
    modal.style.display = "none";
  };

  // Function to print the report
  window.printReport = function () {
    const printContents = document.getElementById('reportOutput').innerHTML;
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
      <html>
        <head>
          <title>Report</title>
          <style>
            body {
              font-family: Arial, sans-serif;
            }
            table {
              width: 100%;
              border-collapse: collapse;
            }
            th, td {
              border: 1px solid #ddd;
              padding: 8px;
              text-align: left;
            }
            th {
              background-color: #4CAF50;
              color: white;
            }
          </style>
        </head>
        <body>
          ${printContents}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  };

  // Event listeners for the report buttons
  document.getElementById('dailyReportBtn').addEventListener('click', () => generateReport('daily'));
  document.getElementById('weeklyReportBtn').addEventListener('click', () => generateReport('weekly'));
  document.getElementById('monthlyReportBtn').addEventListener('click', () => generateReport('monthly'));
</script>
